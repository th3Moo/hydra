<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure PayFast Checkout</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Use a dark-mode theme by default
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#0ff',
                        dark: '#0a0f1f',
                        'dark-alt': '#111a33',
                        'dark-light': '#0d152b',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-dark text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="payment-box bg-dark-alt p-8 rounded-xl shadow-lg max-w-sm w-full">
        <h1 class="text-primary text-3xl font-bold mb-6 text-center">
            Secure PayFast Checkout
        </h1>

        <!-- The PayFast form. The 'signature' and 'timestamp' are generated by JavaScript -->
        <form id="payfastForm"
              name="PayFastPayNowForm"
              action="https://payment.payfast.io/eng/process"
              method="post"
              class="space-y-4">

            <!-- Hidden fields required by PayFast -->
            <input type="hidden" name="cmd" value="_paynow">
            <input type="hidden" name="receiver" value="31286507">
            <input type="hidden" id="timestamp" name="timestamp">
            <input type="hidden" id="signature" name="signature">
            <input type="hidden" id="m_payment_id" name="m_payment_id">
            <input type="hidden" name="item_name" value="Sample Product">

            <!-- Item and Quantity inputs using a modern flex layout -->
            <div class="space-y-4">
                <div>
                    <label for="PayFastAmount" class="block text-sm font-medium text-gray-400 mb-1">
                        Amount
                    </label>
                    <input id="PayFastAmount"
                           type="number"
                           step="0.01"
                           name="amount"
                           min="5.00"
                           value="1999.00"
                           required
                           class="w-full p-2 rounded-lg bg-dark-light border border-gray-600 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-gray-100">
                </div>
                <div>
                    <label for="custom_quantity" class="block text-sm font-medium text-gray-400 mb-1">
                        Quantity
                    </label>
                    <input id="custom_quantity"
                           type="number"
                           name="custom_quantity"
                           value="1"
                           min="1"
                           required
                           class="w-full p-2 rounded-lg bg-dark-light border border-gray-600 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-gray-100">
                </div>
            </div>

            <!-- The PayFast Pay Now button -->
            <div class="mt-6">
                <button type="submit"
                        class="w-full bg-primary text-dark-alt font-bold py-3 rounded-lg shadow-md hover:bg-opacity-80 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-dark-alt">
                    Pay Now
                </button>
            </div>

        </form>
    </div>

    <script>
        // The secure passphrase, which must be kept secret on a real server.
        // For this example, it is hardcoded. In a real application, this must be stored server-side.
        const passphrase = 'your-secret-passphrase-here';

        // Helper function to generate a SHA-256 hash
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // Helper function to get the current timestamp in ISO format
        function getTimestamp() {
            const d = new Date();
            const year = d.getFullYear();
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const day = d.getDate().toString().padStart(2, '0');
            const hour = d.getHours().toString().padStart(2, '0');
            const minute = d.getMinutes().toString().padStart(2, '0');
            const second = d.getSeconds().toString().padStart(2, '0');
            return `${year}-${month}-${day}T${hour}:${minute}:${second}`;
        }

        // Helper function to create a unique merchant payment ID
        function generatePaymentId() {
            return 'PF-' + Date.now() + Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // This function is called when the form is submitted
        document.getElementById('payfastForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            // Get form elements
            const form = event.target;
            const amountInput = document.getElementById('PayFastAmount');
            const quantityInput = document.getElementById('custom_quantity');

            // Calculate the total amount
            const totalAmount = parseFloat(amountInput.value) * parseInt(quantityInput.value, 10);
            amountInput.value = totalAmount.toFixed(2);

            // Get the data to be signed
            const data = {
                'amount': amountInput.value,
                'cmd': form.cmd.value,
                'item_name': form.item_name.value,
                'm_payment_id': generatePaymentId(),
                'receiver': form.receiver.value,
                'timestamp': getTimestamp(),
            };

            // Order the keys alphabetically
            const orderedKeys = Object.keys(data).sort();
            let queryString = '';
            for (const key of orderedKeys) {
                queryString += `${key}=${encodeURIComponent(data[key])}&`;
            }

            // Append the passphrase to the query string
            const signatureString = queryString + `passphrase=${encodeURIComponent(passphrase)}`;

            // Generate the signature
            const signature = await sha256(signatureString);

            // Update the hidden form fields
            form.signature.value = signature;
            form.timestamp.value = data.timestamp;
            form.m_payment_id.value = data.m_payment_id;

            // Submit the form
            form.submit();
        });
    </script>
</body>
</html>
